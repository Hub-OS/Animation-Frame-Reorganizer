s=function(t){var e=t[0],i="'"===e;return t.substring(1,t.length-1).replace(/\\\\/g,"\\").replace(i?/\\'/g:/\\"/g,e)};const t=/\S/g,e=/[\s=]/g;function i(t,e,i){return e.lastIndex=i,e.exec(t)}function r(r,o){let n;let h={},a=r.indexOf(" ");if(a<0)return h;for(;n=i(r,t,a);){if(!(n=i(r,e,a=n.index)))throw Error(`Unexpected "${r.slice(a)}" on line ${o}`);let l=r.slice(a,n.index),u=r.indexOf("=",n.index);if(u<0)throw Error(`Attribute is missing "=" on line ${o}`);if(!(n=i(r,t,u+1)))throw Error(`Attribute is missing value on line ${o}`);let d=n.index,f="";if('"'==r[d]){let t=function(t,e){for(;;){if((e=t.indexOf('"',e))<0)return -1;if(!function(t,e){let i=!1;for(;e>0&&"\\"==t[e-=1];)i=!i;return i}(t,e))break;e+=1}return e}(r,d+1);if(t<0)throw Error(`String missing closing quote on line ${o}`);t+=1,f=s(r.slice(d,t)),a=t}else{let t=r.indexOf(" ",d);t<0&&(t=r.length),f=r.slice(d,t),a=t}h[l]=f}return h}function o(t,e,i={quoteAllValues:!0}){let r=[t];for(let t in e){let o=e[t];switch(typeof o){case"string":""!=o&&(r.push(" "),r.push(t),r.push("="),r.push('"'+o.replace(/\\|"/g,function(t){return"\\"+t})+'"'));break;case"number":0!=o&&(i.quoteAllValues?r.push(` ${t}="${o}"`):r.push(` ${t}=${o}`));break;case"boolean":!0==o&&(r.push(" "),r.push(t),i.quoteAllValues?r.push('="1"'):r.push("=1"));break;case"object":if(Array.isArray(o))break;default:throw Error(`Unexpected ${typeof o} for ${t}`)}}return r.join("")}var s,n={},h={},a=function(){};function l(t,e){let i=t.x+t.w<=e.x,r=t.x>=e.x+e.w,o=t.y+t.h<=e.y,s=t.y>=e.y+e.h;return!(i||r||o||s)}function u(t,e,i){return e>=t.x&&e<t.x+t.w&&i>=t.y&&i<t.y+t.h}function d(t){let e=t.frames[0],i=e.x,r=e.y,o=e.x+e.w,s=e.y+e.h;for(let e=1;e<t.frames.length;e++){let n=t.frames[e];i=Math.min(i,n.x),r=Math.min(r,n.y),o=Math.max(o,n.x+n.w),s=Math.max(s,n.y+n.h)}t.x=i,t.y=r,t.w=o-i,t.h=s-r}function f(t,e,i){let r=e-t.x,o=i-t.y;for(let s of(t.x=e,t.y=i,t.frames))s.x+=r,s.y+=o}a.prototype={fit:function(t){var e,i,r,o,s=t.length,n=s>0?t[0].width:0,h=s>0?t[0].height:0;for(e=0,this.root={x:0,y:0,width:n,height:h};e<s;e++)r=t[e],o=(i=this.findNode(this.root,r.width,r.height))?this.splitNode(i,r.width,r.height):this.growNode(r.width,r.height),r.x=o.x,r.y=o.y},findNode:function(t,e,i){return t.used?this.findNode(t.right,e,i)||this.findNode(t.down,e,i):e<=t.width&&i<=t.height?t:null},splitNode:function(t,e,i){return t.used=!0,t.down={x:t.x,y:t.y+i,width:t.width,height:t.height-i},t.right={x:t.x+e,y:t.y,width:t.width-e,height:i},t},growNode:function(t,e){var i=t<=this.root.width,r=e<=this.root.height,o=r&&this.root.height>=this.root.width+t,s=i&&this.root.width>=this.root.height+e;return o?this.growRight(t,e):s?this.growDown(t,e):r?this.growRight(t,e):i?this.growDown(t,e):null},growRight:function(t,e){var i;return(this.root={used:!0,x:0,y:0,width:this.root.width+t,height:this.root.height,down:this.root,right:{x:this.root.width,y:0,width:t,height:this.root.height}},i=this.findNode(this.root,t,e))?this.splitNode(i,t,e):null},growDown:function(t,e){var i;return(this.root={used:!0,x:0,y:0,width:this.root.width,height:this.root.height+e,down:{x:0,y:this.root.height,width:this.root.width,height:e},right:this.root},i=this.findNode(this.root,t,e))?this.splitNode(i,t,e):null}},h=a,n=function(t,e){e=e||{};var i=new h,r=e.inPlace||!1,o=t.map(function(t){return r?t:{width:t.width,height:t.height,item:t}});o=o.sort(function(t,e){return e.width*e.height-t.width*t.height}),i.fit(o);var s={width:o.reduce(function(t,e){return Math.max(t,e.x+e.width)},0),height:o.reduce(function(t,e){return Math.max(t,e.y+e.height)},0)};return r||(s.items=o),s};const c=document.querySelector("#input canvas"),m=new class{#t;#e;#i;#r;#o;#s;#n;#h;#a;#l;#u;#d;#f;constructor(t){this.#t={},this.#e={},this.#i=[],this.#r=[],this.#a=!1,this.#l=!1,this.#d=0,this.#f=0,this.#o=t,this.#s=t.getContext("2d"),this.#n=document.createElement("canvas"),this.#h=this.#n.getContext("2d"),this.#h.globalCompositeOperation="copy";let e=0,i=0,r=r=>{let o=t.getBoundingClientRect(),s=t.width/o.width;e=Math.floor((r.clientX-o.left)*s),i=Math.floor((r.clientY-o.top)*s)};this.#o.addEventListener("mousedown",t=>{r(t),this.#l=!0,this.#d=e,this.#f=i,this.#r.some(({work:t})=>u(t,e,i))?this.#a=!1:(this.#r=this.#i.filter(({work:t})=>u(t,e,i)),this.#a=0==this.#r.length),this.render()}),document.body.addEventListener("mousemove",t=>{if(!this.#l)return;let o=e,s=i;if(r(t),this.#a){let t=Math.min(e,this.#d),r=Math.min(i,this.#f),o={x:t,y:r,w:Math.max(e,this.#d)-t+1,h:Math.max(i,this.#f)-r+1};this.#u=o,this.#r=this.#i.filter(({work:t})=>l(o,t))}else{let t=e-o,r=i-s;this.#c(t,r)}this.render()}),document.body.addEventListener("mouseup",()=>{this.#l&&(this.#l=!1,this.#u=void 0,this.render())}),this.#o.addEventListener("keydown",t=>{let e=0,i=0;switch(t.code){case"KeyA":case"ArrowLeft":e-=1;break;case"KeyD":case"ArrowRight":e+=1;break;case"KeyW":case"ArrowUp":i-=1;break;case"KeyS":case"ArrowDown":i+=1}(0!=e||0!=i)&&(t.preventDefault(),t.shiftKey?this.#m(e,i):this.#c(e,i),this.render())})}#c(t,e){for(let{work:i}of this.#r)f(i,i.x+t,i.y+e)}#m(t,e){if(0==this.#r.length)return;this.#r.sort((t,e)=>t.work.x-e.work.x);let i=this.#r[0].work.x,r=0;for(let{work:e}of this.#r)e.x!=i&&(i=e.x,r+=t),f(e,e.x+r,e.y);this.#r.sort((t,e)=>t.work.y-e.work.y);let o=this.#r[0].work.y,s=0;for(let{work:t}of this.#r)t.y!=o&&(o=t.y,s+=e),f(t,t.x,t.y+s)}loadSheet(t){var e;let i=t.image;this.#o.width=i.width,this.#o.height=i.height,t.image=void 0,this.#t=t,this.#e=structuredClone(t),t.image=i,this.#e.image=i;let r=function(t){let e=t.flatMap(t=>t.frames),i=[];for(;e.length>0;)i.push(function(t){let e={x:0,y:0,w:0,h:0,frames:[t.pop()]};d(e);for(let i=t.length-1;i>=0;i--){let r=t[i];l(e,r)&&e.frames.some(t=>l(t,r))&&(t[i]=t[t.length-1],t.pop(),e.frames.push(r),d(e))}return e}(e));return i}(this.#e.animations),o=((e=n)&&e.__esModule?e.default:e)(r.map(t=>({width:t.w+2,height:t.h+2,group:t})));for(let t of(this.#i=[],o.items)){let e=t.item.group,i=structuredClone(e);f(i,t.x+1,t.y+1),this.#i.push({work:e,packed:i})}this.#g(o.width,o.height),this.render()}#g(t,e){let i=this.#e.image;for(let{work:r,packed:o}of(this.#n.width=t,this.#n.height=e,this.#i))for(let t=0;t<o.frames.length;t++){let e=r.frames[t],s=o.frames[t],n=e.w,h=e.h;this.#h.drawImage(i,e.x,e.y,n,h,s.x,s.y,n,h)}}descramble(){let t=this.#t.image;if(this.#t.image=void 0,this.#e=structuredClone(this.#t),this.#e.image=t,this.#t.image=t,!this.#e.animations)return;for(let t of(this.#i=[],this.#e.animations))for(let e of t.frames){let{x:t,y:i,w:r,h:o}=e,s={x:t,y:i,w:r,h:o,frames:[e]},n=structuredClone(s);this.#i.push({work:s,packed:n})}t&&this.#g(t.width,t.height);let e=0,i=1,r=1,o=1,s=1;for(let t of this.#e.animations){for(let n of t.frames)f(this.#i[e].work,i,r),i+=n.w+1,o=Math.max(o,r+n.h+1),s=Math.max(s,i),e++;i=1,r=o}this.#o.width=s,this.#o.height=r,this.render()}render(){this.#s.clearRect(0,0,this.#o.width,this.#o.height),this.#w(this.#s),this.#p()}#w(t){for(let{work:e,packed:i}of this.#i)for(let r=0;r<i.frames.length;r++){let o=i.frames[r],s=e.frames[r],n=o.w,h=o.h;t.drawImage(this.#n,o.x,o.y,n,h,s.x,s.y,n,h)}}#p(){let t=this.#s;t.strokeStyle="orange",t.fillStyle="rgba(255, 127, 0, 0.2)";let e=(e,i,r,o)=>{t.beginPath(),t.rect(e+.5,i+.5,r,o),t.fill(),t.stroke()};for(let i of this.#i){t.globalAlpha=this.#r.includes(i)?1:.2;let{x:r,y:o,w:s,h:n}=i.work;e(r,o,s-1,n-1)}if(t.globalAlpha=1,this.#u){let{x:t,y:i,w:r,h:o}=this.#u;e(t,i,r-1,o-1)}}renderOutput(t){t.width=this.#o.width,t.height=this.#o.height;let e=t.getContext("2d");this.#w(e)}serializeSheet(){return this.#e.animations?function(t){let e=[];for(let i of t){for(let t of(e.push(o("animation",i)),i.frames))for(let i of(e.push(o("frame",t)),t.points))e.push(o("point",i));e.push("")}return e.join("\n")}(this.#e.animations):""}}(c),g={};function w(t){console.error(t),alert(t)}async function p(t){for(let e of t)if(e.name.endsWith(".png"))try{g.image=await function(t){return new Promise((e,i)=>{let r=new FileReader;r.onload=function(){let o=new Image;o.src=r.result,o.onload=function(){e(o)},o.onerror=function(){i(Error(`Failed to load "${t.name}"`))}},r.onerror=function(){i(Error(`Failed to load "${t.name}: ${r.error}"`))},r.readAsDataURL(t)})}(e),g.imageError=void 0}catch(t){console.error(t),g.imageError=t.toString()}else if(e.name.endsWith(".animation"))try{let t=await function(t){return new Promise((e,i)=>{let r=new FileReader;r.onload=function(){e(r.result)},r.onerror=function(){i(Error(`Failed to load "${t.name}: ${r.error}"`))},r.readAsText(t)})}(e);g.animations=function(t){let e,i;let o=[],s=0;for(let n of t.split("\n"))if(n=n.trim(),s+=1,!(""==n||n.startsWith("#")||n.startsWith("imagePath")||n.startsWith("version"))){if(n.startsWith("animation ")){let t=r(n,s),i={state:t.state,frames:[]};if(!t.state)throw Error(`Animation is missing state name on line ${s}`);o.push(i),e=i}else if(n.startsWith("frame")||n.startsWith("blank")){if(!e)throw Error(`No animation state to associate frame with on line ${s}`);let t=r(n,s),o={x:parseFloat(t.x)||0,y:parseFloat(t.y)||0,w:parseFloat(t.w)||0,h:parseFloat(t.h)||0,originx:parseFloat(t.originx)||0,originy:parseFloat(t.originy)||0,flipx:1==parseInt(t.flipx),flipy:1==parseInt(t.flipy),duration:t.duration||"",points:[]};e.frames.push(o),i=o}else if(n.startsWith("point ")){if(!i)throw Error(`No frame to associate point with on line ${s}`);let t=r(n,s);if(!t.label)throw Error(`Point is missing label on line ${s}`);let e={label:t.label,x:parseFloat(t.x),y:parseFloat(t.y)};i.points.push(e)}else{let t=n.indexOf(" "),e=t<0?n:n.slice(0,t);throw Error(`Unexpected "${e}" on line ${s}`)}}return o}(t),g.animationError=void 0}catch(t){console.error(t),g.animationError=t.toString()}}document.getElementById("descramble-button").onclick=function(){confirm("Are you sure? This will reorganize every frame and possibly create duplicate frames.")&&m.descramble()},document.getElementById("bake-button").onclick=function(){let t=document.querySelector("#output canvas"),e=document.querySelector("#output textarea");try{m.renderOutput(t),e.value=m.serializeSheet()}catch(t){w(t)}},document.body.addEventListener("dragover",t=>t.preventDefault()),document.body.addEventListener("drop",t=>{let e=t.dataTransfer?.items;if(!e)return;t.preventDefault();let i=[];for(let t of e){let e=t.getAsFile();e&&i.push(e)}p(i).catch(w).finally(()=>{let t=g.animationError?g.animationError:g.imageError?g.imageError:g.animations?g.image?void 0:"Missing image file":"Missing .animation file";document.querySelector("#input .error-text").innerText=t||"",t||m.loadSheet(g)})});
//# sourceMappingURL=index.69435cbb.js.map
