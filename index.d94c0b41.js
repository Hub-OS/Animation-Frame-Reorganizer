h=function(t){var e=t[0],i="'"===e;return t.substring(1,t.length-1).replace(/\\\\/g,"\\").replace(i?/\\'/g:/\\"/g,e)};const t=/\S/g,e=/[\s=]/g;function i(t,e,i){return e.lastIndex=i,e.exec(t)}function r(t,e){for(;;){if((e=t.indexOf('"',e))<0)return -1;if(!function(t,e){let i=!1;for(;e>0&&"\\"==t[e-=1];)i=!i;return i}(t,e))break;e+=1}return e}function o(o,s,n){let a;let l={},u=n??o.indexOf(" ");if(u<0)return l;for(;a=i(o,t,u);){if(!(a=i(o,e,u=a.index)))throw Error(`Unexpected "${o.slice(u)}" on line ${s}`);let n=o.slice(u,a.index),f=o.indexOf("=",a.index);if(f<0)throw Error(`Attribute is missing "=" on line ${s}`);if(!(a=i(o,t,f+1)))throw Error(`Attribute is missing value on line ${s}`);let d=a.index,c="";if('"'==o[d]){let t=r(o,d+1);if(t<0)throw Error(`String missing closing quote on line ${s}`);t+=1,c=h(o.slice(d,t)),u=t}else{let t=o.indexOf(" ",d);t<0&&(t=o.length),c=o.slice(d,t),u=t}l[n]=c}return l}function s(t,e){let i=t.length;for(let r=e??0;r<t.length;r++)if(" "!=t[r]){i=r;break}let r=t.length;for(let e=i;e<t.length;e++)if(" "==t[e]){r=e;break}return[i,t.slice(i,r),t.slice(r)]}function n(t,e,i={quoteAllValues:!0}){let r=[t];for(let t in e){let o=e[t],s=t;switch(i.renamedKeys&&(s=i.renamedKeys[t]||t),typeof o){case"string":""!=o&&((r.push(" "),r.push(s),r.push("="),i.quoteAllValues||o.includes('"')||o.includes(" "))?r.push('"'+o.replace(/\\|"/g,function(t){return"\\"+t})+'"'):r.push(o));break;case"number":0!=o&&(i.quoteAllValues?r.push(` ${s}="${o}"`):r.push(` ${s}=${o}`));break;case"boolean":!0==o&&(r.push(" "),r.push(s),i.quoteAllValues?r.push('="1"'):r.push("=1"));break;case"object":if(Array.isArray(o))break;default:throw Error(`Unexpected ${typeof o} for ${s}`)}}return r.join("")}function a(t){return new Promise((e,i)=>{let r=new FileReader;r.onload=function(){e(r.result)},r.onerror=function(){i(Error(`Failed to load "${t.name}: ${r.error}"`))},r.readAsText(t)})}var h,l={},u={},f=function(){};function d(t,e){let i=t.x+t.w<=e.x,r=t.x>=e.x+e.w,o=t.y+t.h<=e.y,s=t.y>=e.y+e.h;return!(i||r||o||s)}function c(t,e,i){return e>=t.x&&e<t.x+t.w&&i>=t.y&&i<t.y+t.h}function m(t){let e=t.frames[0],i=e.x,r=e.y,o=e.x+e.w,s=e.y+e.h;for(let e=1;e<t.frames.length;e++){let n=t.frames[e];i=Math.min(i,n.x),r=Math.min(r,n.y),o=Math.max(o,n.x+n.w),s=Math.max(s,n.y+n.h)}t.x=i,t.y=r,t.w=o-i,t.h=s-r}function p(t,e,i){let r=e-t.x,o=i-t.y;for(let s of(t.x=e,t.y=i,t.frames))s.x+=r,s.y+=o}f.prototype={fit:function(t){var e,i,r,o,s=t.length,n=s>0?t[0].width:0,a=s>0?t[0].height:0;for(e=0,this.root={x:0,y:0,width:n,height:a};e<s;e++)r=t[e],o=(i=this.findNode(this.root,r.width,r.height))?this.splitNode(i,r.width,r.height):this.growNode(r.width,r.height),r.x=o.x,r.y=o.y},findNode:function(t,e,i){return t.used?this.findNode(t.right,e,i)||this.findNode(t.down,e,i):e<=t.width&&i<=t.height?t:null},splitNode:function(t,e,i){return t.used=!0,t.down={x:t.x,y:t.y+i,width:t.width,height:t.height-i},t.right={x:t.x+e,y:t.y,width:t.width-e,height:i},t},growNode:function(t,e){var i=t<=this.root.width,r=e<=this.root.height,o=r&&this.root.height>=this.root.width+t,s=i&&this.root.width>=this.root.height+e;return o?this.growRight(t,e):s?this.growDown(t,e):r?this.growRight(t,e):i?this.growDown(t,e):null},growRight:function(t,e){var i;return(this.root={used:!0,x:0,y:0,width:this.root.width+t,height:this.root.height,down:this.root,right:{x:this.root.width,y:0,width:t,height:this.root.height}},i=this.findNode(this.root,t,e))?this.splitNode(i,t,e):null},growDown:function(t,e){var i;return(this.root={used:!0,x:0,y:0,width:this.root.width,height:this.root.height+e,down:{x:0,y:this.root.height,width:this.root.width,height:e},right:this.root},i=this.findNode(this.root,t,e))?this.splitNode(i,t,e):null}},u=f,l=function(t,e){e=e||{};var i=new u,r=e.inPlace||!1,o=t.map(function(t){return r?t:{width:t.width,height:t.height,item:t}});o=o.sort(function(t,e){return e.width*e.height-t.width*t.height}),i.fit(o);var s={width:o.reduce(function(t,e){return Math.max(t,e.x+e.width)},0),height:o.reduce(function(t,e){return Math.max(t,e.y+e.height)},0)};return r||(s.items=o),s};const g=document.querySelector("#input canvas"),w=new class{#t;#e;#i;#r;#o;#s;#n;#a;#h;#l;#u;#f;#d;constructor(t){this.#t={},this.#e={},this.#i=[],this.#r=[],this.#h=!1,this.#l=!1,this.#f=0,this.#d=0,this.#o=t,this.#s=t.getContext("2d"),this.#n=document.createElement("canvas"),this.#a=this.#n.getContext("2d"),this.#a.globalCompositeOperation="copy";let e=0,i=0,r=r=>{let o=t.getBoundingClientRect(),s=t.width/o.width;e=Math.floor((r.clientX-o.left)*s),i=Math.floor((r.clientY-o.top)*s)};this.#o.addEventListener("mousedown",t=>{r(t),this.#l=!0,this.#f=e,this.#d=i,this.#r.some(({work:t})=>c(t,e,i))?this.#h=!1:(this.#r=this.#i.filter(({work:t})=>c(t,e,i)),this.#h=0==this.#r.length),this.render()}),document.body.addEventListener("mousemove",t=>{if(!this.#l)return;let o=e,s=i;if(r(t),this.#h){let t=Math.min(e,this.#f),r=Math.min(i,this.#d),o={x:t,y:r,w:Math.max(e,this.#f)-t+1,h:Math.max(i,this.#d)-r+1};this.#u=o,this.#r=this.#i.filter(({work:t})=>d(o,t))}else{let t=e-o,r=i-s;this.#c(t,r)}this.render()}),document.body.addEventListener("mouseup",()=>{this.#l&&(this.#l=!1,this.#u=void 0,this.render())}),this.#o.addEventListener("keydown",t=>{let e=0,i=0;switch(t.code){case"KeyA":case"ArrowLeft":e-=1;break;case"KeyD":case"ArrowRight":e+=1;break;case"KeyW":case"ArrowUp":i-=1;break;case"KeyS":case"ArrowDown":i+=1}(0!=e||0!=i)&&(t.preventDefault(),t.shiftKey?this.#m(e,i):this.#c(e,i),this.render())})}#c(t,e){for(let{work:i}of this.#r)p(i,i.x+t,i.y+e)}#m(t,e){if(0==this.#r.length)return;this.#r.sort((t,e)=>t.work.x-e.work.x);let i=this.#r[0].work.x,r=0;for(let{work:e}of this.#r)e.x!=i&&(i=e.x,r+=t),p(e,e.x+r,e.y);this.#r.sort((t,e)=>t.work.y-e.work.y);let o=this.#r[0].work.y,s=0;for(let{work:t}of this.#r)t.y!=o&&(o=t.y,s+=e),p(t,t.x,t.y+s)}loadSheet(t){var e;let i=t.image;this.#o.width=i.width,this.#o.height=i.height,t.image=void 0,this.#t=t,this.#e=structuredClone(t),t.image=i,this.#e.image=i;let r=function(t){let e=t.flatMap(t=>t.frames),i=[];for(;e.length>0;)i.push(function(t){let e={x:0,y:0,w:0,h:0,frames:[t.pop()]};m(e);for(let i=t.length-1;i>=0;i--){let r=t[i];d(e,r)&&e.frames.some(t=>d(t,r))&&(t[i]=t[t.length-1],t.pop(),e.frames.push(r),m(e))}return e}(e));return i}(this.#e.boomsheet.animations),o=((e=l)&&e.__esModule?e.default:e)(r.map(t=>({width:t.w+2,height:t.h+2,group:t})));for(let t of(this.#i=[],o.items)){let e=t.item.group,i=structuredClone(e);p(i,t.x+1,t.y+1),this.#i.push({work:e,packed:i})}this.#p(o.width,o.height),this.render()}#p(t,e){let i=this.#e.image;for(let{work:r,packed:o}of(this.#n.width=t,this.#n.height=e,this.#i))for(let t=0;t<o.frames.length;t++){let e=r.frames[t],s=o.frames[t],n=e.w,a=e.h;this.#a.drawImage(i,e.x,e.y,n,a,s.x,s.y,n,a)}}unpack(){let t=this.#t.image;if(this.#t.image=void 0,this.#e=structuredClone(this.#t),this.#e.image=t,this.#t.image=t,!this.#e.boomsheet)return;for(let t of(this.#i=[],this.#e.boomsheet.animations))for(let e of t.frames){let{x:t,y:i,w:r,h:o}=e,s={x:t,y:i,w:r,h:o,frames:[e]},n=structuredClone(s);this.#i.push({work:s,packed:n})}t&&this.#p(t.width,t.height);let e=0,i=1,r=1,o=1,s=1;for(let t of this.#e.boomsheet.animations){for(let n of t.frames)p(this.#i[e].work,i,r),i+=n.w+1,o=Math.max(o,r+n.h+1),s=Math.max(s,i),e++;i=1,r=o}this.#o.width=s,this.#o.height=r,this.render()}render(){this.#s.clearRect(0,0,this.#o.width,this.#o.height),this.#g(this.#s),this.#w()}#g(t){for(let{work:e,packed:i}of this.#i)for(let r=0;r<i.frames.length;r++){let o=i.frames[r],s=e.frames[r],n=o.w,a=o.h;t.drawImage(this.#n,o.x,o.y,n,a,s.x,s.y,n,a)}}#w(){let t=this.#s;t.strokeStyle="lime",t.fillStyle="rgba(0, 255, 0, 0.2)";let e=(e,i,r,o)=>{t.beginPath(),t.rect(e+.5,i+.5,r,o),t.fill(),t.stroke()};for(let i of this.#i){t.globalAlpha=this.#r.includes(i)?1:.2;let{x:r,y:o,w:s,h:n}=i.work;e(r,o,s-1,n-1)}if(t.globalAlpha=1,this.#u){let{x:t,y:i,w:r,h:o}=this.#u;e(t,i,r-1,o-1)}}renderOutput(t){t.width=this.#o.width,t.height=this.#o.height;let e=t.getContext("2d");this.#g(e)}boomsheet(){return this.#e.boomsheet}}(g),y={},x=document.getElementById("animation-output"),v=document.getElementById("points-output");function b(t){console.error(t),alert(t)}async function S(t){for(let e of t)if(e.name.endsWith(".png"))try{y.image=await function(t){return new Promise((e,i)=>{let r=new FileReader;r.onload=function(){let o=new Image;o.src=r.result,o.onload=function(){e(o)},o.onerror=function(){i(Error(`Failed to load "${t.name}"`))}},r.onerror=function(){i(Error(`Failed to load "${t.name}: ${r.error}"`))},r.readAsDataURL(t)})}(e),y.imageError=void 0}catch(t){console.error(t),y.imageError=t.toString()}else if(e.name.endsWith(".animation")||e.name.endsWith(".anim"))try{let t=await a(e);y.boomsheet=function(t){let e,i;let n=[],a={version:"modern",animations:n},h=0;for(let l of t.split("\n"))if(l=l.trim(),h+=1,!(""==l||l.startsWith("#")||l.startsWith("!")||l.startsWith("imagePath")||l.startsWith("version"))){if(l.startsWith("anim ")||l.startsWith("animation ")){let t;let i=l.indexOf(" ");if(-1==i)throw Error(`Animation is missing state name on line ${h}`);let[u,f,d]=s(l.slice(i));if(f.startsWith("state=")||"state"==f&&s(d)[1].startsWith("=")?(a.version="legacy",t=o(l,h).state):t=f.startsWith('"')?(d=l.slice(i).trim()).slice(1,r(d,1)):l.slice(i).trim(),void 0==t)throw Error(`Animation is missing state name on line ${h}`);let c={state:t,frames:[]};n.push(c),e=c}else if(l.startsWith("frame")||l.startsWith("blank")){if(!e)throw Error(`No animation state to associate frame with on line ${h}`);let t=o(l,h),r={x:parseFloat(t.x)||0,y:parseFloat(t.y)||0,w:parseFloat(t.w)||0,h:parseFloat(t.h)||0,originx:parseFloat(t.originx)||0,originy:parseFloat(t.originy)||0,flipx:1==parseInt(t.flipx),flipy:1==parseInt(t.flipy),duration:t.duration||t.dur||"",points:[]};e.frames.push(r),i=r}else if(l.startsWith("point ")){let t;if(!i)throw Error(`No frame to associate point with on line ${h}`);let e=6,[n,a,u]=s(l,6);if(a.startsWith('"')){let i=r(l,n+1);t=l.slice(n+1,i),e=i+1}let f=o(l,h,e);if(!(t=t??f.label))throw Error(`Point is missing label on line ${h}`);let d={label:t,x:parseFloat(f.x),y:parseFloat(f.y)};i.points.push(d)}else{let t=l.indexOf(" "),e=t<0?l:l.slice(0,t);throw Error(`Unexpected "${e}" on line ${h}`)}}return a}(t),y.animationError=void 0}catch(t){console.error(t),y.animationError=t.toString()}else if(e.name.endsWith(".json"))try{let t=await a(e),i=JSON.parse(t);if("object"==typeof i&&Array.isArray(i.frames)){let[t,e]=(prompt("Origin:","0,0")??"0,0").split(",").map(t=>parseFloat(t));for(let r of(t??=0,e??=0,y.boomsheet=function(t){if(!Array.isArray(t.frames))throw"Only Array format is supported for Aseprite sheets";let e=[],i=t.meta.frameTags;Array.isArray(i)&&0!=i.length||(i=[{name:"DEFAULT",from:0,to:Math.max(t.frames.length-1,0),direction:"forward"}]);let r=t.frames;for(let t of i){let i=[];for(let e=t.from;e<=t.to;e++){let t=r[e],o={x:t.frame.x,y:t.frame.y,w:t.frame.w,h:t.frame.h,originx:-(t.spriteSourceSize?.x??0),originy:-(t.spriteSourceSize?.y??0),flipx:!1,flipy:!1,duration:(t.duration/1e3).toString(),points:[]};i.push(o)}t.direction.toLowerCase().includes("reverse")&&i.reverse(),e.push({state:t.name,frames:i})}return{version:"modern",animations:e}}(i),y.boomsheet.animations))for(let i of r.frames)i.originx+=t,i.originy+=e;y.animationError=void 0}}catch(t){console.error(t),y.animationError=t.toString()}}function k(){let t=document.querySelector("input[name='animation-output-options']:checked"),e=[x,v],i=t.value+"-output";for(let t of e)t.style.display=t.id==i?"":"none"}document.getElementById("unpack-button").onclick=function(){confirm("Are you sure? This will reorganize every frame and possibly create duplicate frames.")&&w.unpack()},document.getElementById("bake-button").onclick=function(){let t=document.querySelector("#output canvas");document.querySelector("#output textarea");try{w.renderOutput(t);let e=w.boomsheet();e?(x.value=function(t){let e=[],i={quoteAllValues:!0};for(let r of("modern"==t.version&&(i.quoteAllValues=!1,i.renamedKeys={duration:"dur"}),t.animations)){for(let o of("modern"==t.version?e.push("anim "+r.state):e.push(n("animation",r,i)),r.frames))for(let t of(e.push(n("frame",o,i)),o.points))e.push(n("point",t,i));e.push("")}return e.join("\n")}(e),v.value=function(t){let e=[],i={quoteAllValues:!0};for(let r of("modern"==t.version&&(i.quoteAllValues=!1,i.renamedKeys={duration:"dur"}),t.animations)){let o=[],s=!1;for(let a of("modern"==t.version?o.push("anim "+r.state):o.push(n("animation",r,i)),r.frames)){let t={x:0,y:0,w:0,h:0,originx:0,originy:0,flipx:!1,flipy:!1,duration:a.duration,points:[]};if(o.push(n("frame",t,i)),a.points&&a.points.length>0)for(let t of(e.push(...o),o=[],s=!0,a.points)){let r={label:t.label,x:t.x-a.originx,y:t.y-a.originy};e.push(n("point",r,i))}}s&&e.push("")}return e.join("\n")}(e)):(x.value="",v.value="")}catch(t){b(t)}},document.body.addEventListener("dragover",t=>t.preventDefault()),document.body.addEventListener("drop",t=>{let e=t.dataTransfer?.items;if(!e)return;t.preventDefault();let i=[];for(let t of e){let e=t.getAsFile();e&&i.push(e)}S(i).catch(b).finally(()=>{let t=y.animationError?y.animationError:y.imageError?y.imageError:y.boomsheet?y.image?void 0:"Missing image file":"Missing .animation file";document.querySelector("#input .error-text").innerText=t||"",t||w.loadSheet(y)})}),document.querySelectorAll("input[name='animation-output-options']").forEach(t=>t.addEventListener("change",k)),k();
//# sourceMappingURL=index.d94c0b41.js.map
